name: Automated VAPT Pipeline

on:
  schedule:
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      target:
        description: 'Target IP (Phase 1 & 2)'
        required: true
        default: '10.0.2.3'
      webapp_target:
        description: 'Target URL for DAST scan (Phase 3)'
        required: true
        default: 'http://172.17.0.2/'
      workspace:
        description: 'Faraday workspace'
        required: true
        default: 'forenzy_lab'
      profile:
        description: 'Nmap scan profile'
        required: true
        type: choice
        options:
          - quick
          - full
          - vuln
        default: 'quick'

env:
  WORKSPACE: ${{ github.event.inputs.workspace || 'forenzy_lab' }}
  PROFILE: ${{ github.event.inputs.profile || 'quick' }}
  FARADAY_URL: 'http://localhost:5985'

jobs:
  vapt-scan:
    name: VAPT Security Scan
    # THIS IS THE KEY: It tells GitHub to use your Kali VM, not the cloud!
    runs-on: self-hosted 
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üìö Install Python Dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install --upgrade pip --break-system-packages
          pip3 install -r requirements.txt --break-system-packages
          echo "‚úì Python dependencies installed"
      
      - name: üï∑Ô∏è Ensure ZAP Daemon is Running
        run: |
          # Checks if Zap is running, if not, starts it.
          if ! docker ps | grep -q zap-daemon; then
            echo "Starting ZAP Daemon..."
            docker run -d -u zap --name zap-daemon -p 8080:8080 --rm \
              ghcr.io/zaproxy/zaproxy:stable zap.sh -daemon -port 8080 -host 0.0.0.0 \
              -config api.disablekey=true \
              -config api.addrs.addr.name=.* \
              -config api.addrs.addr.regex=true \
              -config proxy.ip=0.0.0.0
            sleep 15
          else
            echo "‚úì ZAP Daemon is already running"
          fi
      
      - name: üéØ Run VAPT Pipeline
        env:
          FARADAY_USERNAME: ${{ secrets.FARADAY_USERNAME }}
          FARADAY_PASSWORD: ${{ secrets.FARADAY_PASSWORD }}
        run: |
          NETWORK_TARGET="${{ github.event.inputs.target || '10.0.2.3' }}"
          WEBAPP_TARGET="${{ github.event.inputs.webapp_target || 'http://172.17.0.2/' }}"
        
          echo "Running Phase 1, 2, 4 (Network & Alerts)"
          python pipeline.py \
            --target "$NETWORK_TARGET" \
            --workspace "${{ env.WORKSPACE }}" \
            --profile "${{ env.PROFILE }}" \
            --phases "1,2,4"

          echo "Running Phase 3 (DAST ZAP Scan)"
          python pipeline.py \
            --target "$WEBAPP_TARGET" \
            --workspace "${{ env.WORKSPACE }}" \
            --phases "3"

      - name: üì¶ Archive Final Reports Only
        if: always()
        run: |
          zip -j final_vapt_report.zip reports/*.html reports/*.json ./*.log
      - name: üì§ Upload Final Report
        if: always()
        env:
          NODE_OPTIONS: "--dns-result-order=ipv4first"
        uses: actions/upload-artifact@v4
        with:
          name: Final-Compliance-Report
          path: final_vapt_report.zip
          retention-days: 7
          compression-level: 0
        timeout-minutes: 10