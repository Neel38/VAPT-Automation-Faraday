name: Automated VAPT Pipeline

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    # Allow manual trigger with optional inputs
    inputs:
      target:
        description: 'Target IP or CIDR range'
        required: true
        default: '192.168.1.0/24'
      profile:
        description: 'Nmap scan profile'
        required: true
        type: choice
        options:
          - quick
          - full
          - vuln
        default: 'quick'
      workspace:
        description: 'Faraday workspace'
        required: true
        default: 'lab_scan'

env:
  FARADAY_URL: 'http://localhost:5985'
  WORKSPACE: ${{ github.event.inputs.workspace || 'lab_scan' }}
  PROFILE: ${{ github.event.inputs.profile || 'quick' }}

jobs:
  vapt-scan:
    name: VAPT Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      issues: write
      pull-requests: write
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3
      
      - name: üêç Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nmap
          echo "‚úì System dependencies installed"
      
      - name: üìö Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úì Python dependencies installed"
      
      - name: üîê Configure Credentials
        run: |
          echo "Setting up environment variables..."
          echo "FARADAY_API_KEY=${{ secrets.FARADAY_API_KEY }}" >> $GITHUB_ENV
          echo "Credentials configured"
      
      - name: üìã Validate Environment
        run: |
          nmap --version
          python --version
          python -c "import yaml, requests, jinja2; print('All imports successful')"
          echo "‚úì Environment validation complete"
      
      - name: üéØ Run VAPT Pipeline
        run: |
          TARGET="${{ github.event.inputs.target || '192.168.1.0/24' }}"
          echo "Starting VAPT Pipeline..."
          echo "Target: $TARGET"
          echo "Workspace: ${{ env.WORKSPACE }}"
          echo "Profile: ${{ env.PROFILE }}"
          
          python pipeline.py \
            --target "$TARGET" \
            --workspace "${{ env.WORKSPACE }}" \
            --profile "${{ env.PROFILE }}" \
            --framework owasp
      
      - name: üö® Run Alert Engine
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è  Slack webhook not configured, skipping Slack alerts"
          else
            python alert_engine.py --workspace "${{ env.WORKSPACE }}"
          fi
      
      - name: üé´ Sync Ticketing System
        continue-on-error: true
        run: |
          python ticket_manager.py sync --workspace "${{ env.WORKSPACE }}"
          python ticket_manager.py stats
      
      - name: üìä Generate Compliance Report
        continue-on-error: true
        run: |
          mkdir -p reports
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          python report_generator.py \
            --workspace "${{ env.WORKSPACE }}" \
            --format html \
            --framework owasp \
            --output "reports/compliance_report_${{ env.WORKSPACE }}_$TIMESTAMP.html"
      
      - name: üì§ Upload Scan Results as Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: VAPT-Reports-${{ github.run_id }}
          path: |
            reports/
            scan.log
            alert_engine.log
            report_generator.log
            pipeline.log
          retention-days: 30
      
      - name: üìà Publish Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: Pipeline-Logs-${{ github.run_id }}
          path: |
            **/*.log
          retention-days: 7
      
      - name: ‚úÖ Pipeline Complete
        if: success()
        run: |
          echo "‚úì VAPT Pipeline execution completed successfully"
          echo "üìä Artifacts available in GitHub Actions run"

  # Optional: Create GitHub Issues for Critical findings
  report-findings:
    name: Report Critical Findings
    runs-on: ubuntu-latest
    needs: vapt-scan
    if: always()
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3
      
      - name: üêç Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
      
      - name: üîç Check for Critical Findings
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for critical findings to report..."
          # This would typically query Faraday API and create issues for critical findings
          echo "Report function placeholder"

  # Optional: Slack Notification
  notify-slack:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: vapt-scan
    if: always()
    
    steps:
      - name: üì¢ Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "VAPT Pipeline Run Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*VAPT Pipeline - ${{ job.status }}*\nWorkflow: `${{ github.workflow }}`\nBuild: ${{ github.run_number }}\nRun ID: ${{ github.run_id }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
